[anonymous-telemetry]
# This is opt-in by default, but we explicitly disable here as well.
enabled = false
# repo_id here allows individuals to opt-in on their machine
# To opt-in, use ~/.pants.rc or envrc to set [anonymous-telemetry].enabled=true
repo_id = "de0dea7a-9f6a-4c6e-aa20-6ba5ad969b8a"

[GLOBAL]
pants_version = "2.14.0rc3"
pythonpath = ["%(buildroot)s/pants-plugins"]
build_file_prelude_globs = ["pants-plugins/macros.py"]
backend_packages = [
  # python
  "pants.backend.python",
  "pants.backend.experimental.python", # activates twine `publish` support
  "pants.backend.python.mixed_interpreter_constraints",
# if enabled, autoflake and pyupgrade should be before black and isort
#  "pants.backend.experimental.python.lint.autoflake",
#  "pants.backend.experimental.python.lint.pyupgrade",
  "pants.backend.python.lint.bandit",
  "pants.backend.python.lint.black",
#  "pants.backend.python.lint.docformatter",
  "pants.backend.python.lint.flake8",
#  "pants.backend.python.lint.isort",
  "pants.backend.python.lint.pylint",
#  "pants.backend.python.typecheck.mypy",

  # shell
  "pants.backend.shell",
#  "pants.backend.shell.lint.shfmt",
  "pants.backend.shell.lint.shellcheck",

  # internal plugins in pants-plugins/
  "pants.backend.plugin_development",
  # TODO: move these under a plugins namespace so they're not top-level
  "uses_services",
  "sample_conf",
  "schemas",
  "api_spec",
  "stevedore_extensions",
  "pack_metadata",
  "do_invoke",
  "release",
]
plugins = [
  # dependencies for internal plugins
  #"distro",  # dep of the pex
  "invoke==1.7.1",
]
# pants ignores files in .gitignore, .*/ directories, /dist/ directory, and __pycache__.
pants_ignore.add = [
  # TODO: remove these once we start building wheels with pants.
  "dist_utils.py",
  "setup.py",
  # keep tailor from using legacy requirements files (not for pants)
  "contrib/examples/requirements.txt",
  "contrib/hello_st2/requirements.txt",
  "contrib/runners/*/in-requirements.txt",
  "contrib/runners/*/requirements.txt",
  "st2*/in-requirements.txt",
  "st2*/requirements.txt",
  "st2common/tests/fixtures/requirements-used-for-tests.txt",
  "/fixed-requirements.txt",
  "/test-requirements.txt",
  # keep requirements.txt for now. We might ignore it if we need an alternate interrim
  # file that is decoupled from our legacy requirements files generation.
  "/requirements.txt",
]

[source]
# recording each pack individually under root patterns is not great, but resolves these issues:
# - Using a /contrib/* or other glob in root_patterns is dodgy as runners & schemas are in the same dir.
#   In particular, with /contrib/* in root_patterns, *_runner imports become ambiguous
#   (eg `import noop_runner` should use runners/noop_runner/noop_runner not runners/noop_runner).
# - Using pack.yaml in marker_filenames prevents pants from inferring which fixture packs are
#   used by which tests. We import a PACK_NAME and PACK_PATH from fixture.py in each of these
#   fixture packs to enable this dependency inferrence. Having fine grained inferrence in-turn
#   reduces the number of tests that need to be re-run when we change a fixture.
# - Using another marker_file, like PACK_ROOT, is also problematic because of the core pack.
#   /contrib/core is symlinked to /st2tests/st2tests/fixtures/packs/core for use as a fixture.
#   It is used in quite a few tests, so it needs to continue living in both places.
#   But, overlapping source roots (for st2tests and the pack) make importing from the fixture
#   as we do with the other fixtures impossible.
# Thus, we really do need to register each pack in contrib (but never under st2tests) separately.
# We might also need to register packs in st2tests/testpacks.
root_patterns = [
  # root conftest.py
  "/",
  # core libs
  "/st2*",
  # runners
  "/contrib/runners/*_runner",
  # packs (list /contrib/* packs individually; see note above)
  "/contrib/chatops",
  "/contrib/core", # WARNING: also symlinked to st2tests/st2tests/fixtures/packs/core
  "/contrib/default",
  "/contrib/examples",
  "/contrib/hello_st2",
  "/contrib/linux",
  "/contrib/packs",
  "/st2tests/testpacks/checks",
  "/st2tests/testpacks/errorcheck",
  # odd import in examples.isprime
  "/contrib/examples/lib",
  # lint plugins
  "/pylint_plugins",
  # pants plugins
  "/pants-plugins",
  # invoke tasks
  "/tasks",
  # misc
  "/scripts",
  "/tools",
  # benchmarks
  "/st2common/benchmarks/micro",
]

[python]
#resolver_version = "pip-2020-resolver"
enable_resolves = true
lockfile_generator = "pex"
default_resolve = "st2"
interpreter_constraints = [
  # python_distributions needs a single constraint.
  "CPython>=3.6,!=3.7.*,<3.9",
  #"CPython==3.6.*",
  #"CPython==3.8.*",
]
# tailor recommends adding a `pex_binary` target for every python
# file that has an `if __name__ == "__main__":` block.
# But those are mostly just for testing purposes. So, ignore them for now.
# tailor_pex_binary_targets = false # defaults to false from 2.14.0.dev1
# Any solitary __init__.py files we have are empty. So, leave the default (true).
#tailor_ignore_solitary_init_files = true

[python.resolves]
st2 = "lockfiles/st2"
pylint_plugins = "lockfiles/pylint_plugins" # lockfiles/pylint should have same contents
pants-plugins = "lockfiles/pants-plugins"

[python.resolves_to_interpreter_constraints]
pants-plugins = [
  # See: https://www.pantsbuild.org/docs/prerequisites
  "CPython==3.7.*",
  "CPython==3.8.*",
  "CPython==3.9.*",
]

[setup-py-generation]
# when building the package (with ./pants package ::), pants will,
# by default, generate a setup.py file for use with setuptools.
generate_setup_default = true # true by default

[setuptools]
lockfile = "lockfiles/setuptools"

[bandit]
lockfile = "lockfiles/bandit"
version = "bandit==1.7.0"
args = [
  "-lll",  # only HIGH severity level
  "--exclude",
  "build,dist",
  "--quiet",  # only show output in the case of an error
]

[black]
lockfile = "lockfiles/black"
version = "black==22.3.0"
interpreter_constraints = [
  # pants default constraints for black
  "CPython<4,>=3.7",
]

[flake8]
lockfile = "lockfiles/flake8"
version = "flake8>=3.7.9,<3.9"
extra_requirements = [
  # license check plugin
  "st2flake8==0.1.0",  # TODO: remove in favor of regex-lint
]
config = "lint-configs/python/.flake8"

[pylint]
lockfile = "lockfiles/pylint"
version = "pylint~=2.8.2"
# < 2.7 doesn't work with the version of astroid pinned for the plugin
extra_requirements = [
  "setuptools", # includes pkg_resources
]
config = "lint-configs/python/.pylintrc"
source_plugins = [
  # the /pylint_plugins directory
  "pylint_plugins",
]
args = [
  # concurrency is not handled by pants for linters (yet)
  # using 0 allows pylint to auto-detect the number of available processors.
  # if needed (eg in CI) use an env var like this to override the jobs count:
  #   PANTS_PYLINT_ARGS='+["--jobs=4"]'
  "--jobs=0",
  # match the current Makefile usage with -E (TODO: drop this)
  "--errors-only",
  # needed in st2* components, runners, packs
  "--load-plugins=api_models",
  # needed in st2* components, runners
  "--load-plugins=db_models",
]

[pytest]
lockfile = "lockfiles/pytest"
version = "pytest>=6.0.1,<6.3"
extra_requirements.add = [
  "pytest-benchmark[histogram]==3.4.1",
  #"pytest-timer[colorama]",  # report test timing (--with-timer ala nose-timer)
  "pytest-icdiff",  # make diff output easier to read
  "pygments",  # highlight code in tracebacks

  # other possible plugins
  #"pytest-timeout",  # time limit on tests
  #"pytest-cov",  # coverage
  #"pytest-mock",  # more convenient mocking

  # do not add: xdist (pants runs tests in parallel already)
]
args = [
  "--no-header",  # don't print pytest version for every tested file
]
execution_slot_var = "ST2TESTS_PARALLEL_SLOT"

[twine]
lockfile = "lockfiles/twine"
version = "twine>=3.7.1,<3.8"

[subprocess-environment]
env_vars.add = [
  # vars to trigger injecting pydevd-pycharm
  "ST2_PYCHARM_DEBUG",
  "ST2_PYCHARM_DEBUG_HOST",
  "ST2_PYCHARM_DEBUG_PORT",
  # For users testing with python from XCode, make sure to export ARCHFLAGS
  # see: https://github.com/pantsbuild/pants/pull/11733
  "ARCHFLAGS",
]

[regex-lint]
config = "@lint-configs/regex-lint.yaml"
